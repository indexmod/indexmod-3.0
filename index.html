<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Indexmod Topics</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1>Список топиков</h1>
    <div id="topics" class="columns-container"></div>
  </div>

  <!-- Модалка для статьи -->
  <div id="modal">
    <div id="modal-content">
      <button id="close-modal">Закрыть</button>
      <div id="article"></div>
      <button id="save-md">Скачать MD</button>
      <button id="save-pdf">Скачать PDF</button>
    </div>
  </div>

  <script>
    async function loadTopics() {
      const response = await fetch("topics.txt");
      const text = await response.text();
      let topics = text.split("\n").map(t => t.trim()).filter(t => t.length > 0);
      topics.sort((a,b) => a.localeCompare(b));

      const container = document.getElementById("topics");

      let currentLetter = "";
      let columns = [document.createElement("div"), document.createElement("div"), document.createElement("div")];
      columns.forEach(c => c.className = "column");

      topics.forEach((topic, i) => {
        const first = topic[0].toUpperCase();
        if (first !== currentLetter) {
          currentLetter = first;
          const h = document.createElement("h2");
          h.textContent = currentLetter;
          columns[i % 3].appendChild(h);
        }

        const div = document.createElement("div");
        div.className = "topic";
        div.textContent = topic;
        div.onclick = () => openArticle(topic);
        columns[i % 3].appendChild(div);
      });

      columns.forEach(c => container.appendChild(c));
    }

    async function generateArticle(topic) {
      try {
        const response = await fetch("https://steep-block-7d70.indexmod-ce3.workers.dev/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ topic })
        });
        const data = await response.json();
        return data.article || `Ошибка генерации статьи для темы "${topic}"`;
      } catch (err) {
        return `Ошибка запроса: ${err.message}`;
      }
    }

    function openArticle(topic) {
      generateArticle(topic).then(article => {
        document.getElementById("article").innerHTML = `<h2>${topic}</h2><pre>${article}</pre>`;
        document.getElementById("modal").style.display = "flex";

        document.getElementById("save-md").onclick = () => saveMD(topic, article);
        document.getElementById("save-pdf").onclick = () => savePDF();
      });
    }

    function saveMD(topic, text) {
      const blob = new Blob([text], { type: "text/markdown" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${topic}.md`;
      a.click();
    }

    function savePDF() {
      window.print();
    }

    document.getElementById("close-modal").onclick = () => {
      document.getElementById("modal").style.display = "none";
    };

    loadTopics();
  </script>
</body>
</html>
